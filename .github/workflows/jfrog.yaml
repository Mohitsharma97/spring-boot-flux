name: JFrog Xray Security Scan

on:
  pull_request:
    paths:
      - '**/*.jar'
      - '**/*.pom'
      - '**/*.json'
      - '**/*.yml'

jobs:
  xray_scan:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Check out the code
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Set up JFrog CLI
    - name: Set up JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      with:
        version: '2.72.2'

    # Step 3: Configure JFrog CLI (Authenticate with API key)
    - name: JFrog CLI Configuration
      run: |
        jf config add --url https://trial35x8wp.jfrog.io/artifactory --user ${{ secrets.JFROG_USERNAME }} --apikey ${{ secrets.JFROG_API_KEY }}

    # Step 4: Verify JFrog CLI configuration
    - name: Verify JFrog CLI Configuration
      run: |
        jf config show
        jf rt ping

    # Step 5: Run Xray security scan on specific file types
    - name: Run JFrog Xray Scan
      run: |
        jf xr scan --licenses --format=json --fail-on-severity=critical **/*.jar **/*.pom **/*.json **/*.yml
      continue-on-error: false

    # Step 6: Upload scan results as an artifact (optional)
    - name: Upload scan results
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: xray-scan-results
        path: /home/runner/work/_temp
