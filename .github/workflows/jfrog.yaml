name: JFrog Xray Security Scan

on:
  pull_request:
    paths:
      - '**/*.pom'
      - '**/*.jar'
      - '**/*.yml'
      - '**/*.json'

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository code
      - name: Checkout repository
        uses: actions/checkout@v2

      # Set up JFrog CLI
      - name: Set up JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: 'latest'

      # Authenticate with JFrog
      - name: Authenticate with JFrog
        run: |
          jf config add --url https://trial35x8wp.jfrog.io/artifactory --user ${{ secrets.JFROG_USER }} --apikey ${{ secrets.JFROG_API_KEY }}

      # Verify JFrog CLI version
      - name: Verify JFrog CLI version
        run: jf --version

      # Run Xray scan
      - name: Run Xray security scan
        run: |
          jf xr scan --licenses --format=json **/*.jar **/*.pom **/*.json **/*.yml

      # Post scan results to PR
      - name: Create PR comment with scan results
        run: |
          scan_results=$(jf xr scan --licenses --format=json **/*.jar **/*.pom **/*.json **/*.yml)
          pr_url="https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
          curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -d "{\"body\": \"### JFrog Xray Security Scan Results\n\n$scan_results\"}" \
            $pr_url
