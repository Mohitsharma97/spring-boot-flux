name: JFrog Xray Security Scan

on:
  pull_request:
    paths:
      - '**/*.pom'
      - '**/*.jar'
      - '**/*.yml'
      - '**/*.json'

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      # Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Set up JFrog CLI
      - name: Set up JFrog CLI
        run: |
          curl -fL https://getcli.jfrog.io | sh
          ./jfrog rt config \
            --url https://trial35x8wp.jfrog.io/artifactory \
            --user "${{ secrets.JFROG_USER }}" \
            --apikey "${{ secrets.JFROG_API_KEY }}"

      # Perform JFrog Xray Security Scan
      - name: Perform Security Scan
        id: xray-scan
        run: |
          ./jfrog rt scan \
            --licenses --fail-on-severity=critical \
            --output=json > scan_results.json || true

      # Parse and post scan results to the PR
      - name: Create PR comment with security results
        run: |
          scan_results=$(jfrog rt scan --output=json --licenses --fail-on-severity=critical --debug)
          if [[ $? -ne 0 ]]; then
            echo "JFrog Xray scan failed. Check the logs for more details."
            pr_url="https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
            curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -d "{\"body\": \"### JFrog Xray Security Scan Results\n\n**Summary:**\nError generating scan results. Please check the logs.\n\n**Details:**\n\`\`\`json\n$scan_results\n\`\`\`\"}" \
              $pr_url
          else
            pr_url="https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
            curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -d "{\"body\": \"### JFrog Xray Security Scan Results\n\n$scan_results\"}" \
              $pr_url
          fi

