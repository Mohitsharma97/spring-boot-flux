name: JFrog Xray Security Scan and Deploy Artifacts

on:
  pull_request:
    paths:
      - '**/*.pom'
      - '**/*.jar'
      - '**/*.yml'
      - '**/*.json'

jobs:
  security-scan-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v2

      # Set up JDK 17
      # - name: Set up JDK 17
      #   uses: actions/setup-java@v3
      #   with:
      #     java-version: '17'
      #     distribution: 'temurin'

      # Install JFrog CLI
      - name: Install JFrog CLI
        run: |
          curl -fL https://getcli.jfrog.io | bash
          echo "$HOME/.jfrog/bin" >> $GITHUB_PATH  # Ensure it's added to the PATH for subsequent steps

      # Set up JFrog CLI with authentication
      - name: Set up JFrog CLI with authentication
        run: |
          jfrog rt config --url https://trial35x8wp.jfrog.io/artifactory \
            --user ${{ secrets.JFROG_USER }} \
            --apikey ${{ secrets.JFROG_API_KEY }}

      # Build and Deploy to JFrog
      # - name: Build and Deploy to JFrog
      #   run: |
      #     mvn clean install -DskipTests
      #     mvn deploy -DskipTests

      # Perform a JFrog Xray Security Scan
      - name: JFrog Xray Security Scan
        run: |
          jfrog rt scan --licenses --fail-on-severity=critical --output=json > scan-results.json

      # Add the security results to the PR comments
      - name: Create PR comment with security results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f scan-results.json ]; then
            scan_results=$(cat scan-results.json)
          else
            scan_results="Error generating scan results. Please check the logs."
          fi

          pr_url="https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
          curl -X POST -H "Authorization: token $GITHUB_TOKEN" \
            -d "{\"body\": \"### JFrog Xray Security Scan Results\n\n**Summary:**\n\`\`\`json\n$scan_results\n\`\`\`\n**Details:**\nScan completed.\"}" \
            $pr_url
